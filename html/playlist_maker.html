<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
  <meta charset="utf-8">
  <meta name="theme-color" content="#222222">
  <meta content="yes" name="apple-mobile-web-app-capable">
  
<title>Playlist Maker</title>
<style>

  :root {
    --c-1: #111;
    --c-f: #fff;
    --c-2: #222;
    --c-3: #333;
    --c-4: #444;
    --c-5: #555;
    --c-6: #666;
    --c-8: #888;
    --c-b: #bbb;
    --c-c: #ccc;
    --c-e: #eee;
    --c-f: #fff;
    --c-d: #ddd;
    --c-r: #831;
    --t-b: 0.5;
    --c-o: rgba(34, 34, 34, 0.9);
    --c-tb: rgba(34, 34, 34, var(--t-b));
    --c-tba: rgba(102, 102, 102, var(--t-b));
    --c-tbh: rgba(51, 51, 51, var(--t-b));
    --th: 70px;
    --tp: 70px;
    --bh: 63px;
    --tbp: 14px 14px 10px 14px;
    --bbp: 9px 0 7px 0;
    --bhd: none;
    --bmt: 0px
  }

  html {
    touch-action: manipulation
    overflow: auto;
  }

  body {
    margin: 0;
		font-family: Arial, sans-serif;
		color: #faffff;
		background: #111;
    font-size: 17px;
    color: var(--c-f);
    text-align: center;

    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    scrollbar-width: 6px;
    scrollbar-color: var(--c-sb) transparent
  }
  
  body,
  html {
    height: 100%;
    width: 100%;
  }


  .plm {
    display: flex;
    justify-content: center;
  }

  .plm div {
    flex: 500px 0 0;
    border:1px solid #fff;
  }

  ul,
  #ul_playlist {
    padding: 0;
    margin: 0;
    max-width: 500px;
  }

  #ul_playlist {
    background-color: var(--c-3);
  }

  li {
    list-style: none;
    padding: 12px 16px;
		background-color: #0e81ec;
    margin: 4px;
    cursor: move;
		border-radius: 0.3rem;
  }

  li.selected {
    background: rgba(255,0,0,.5);
  }

  input[type=number],
  input[type=text] {
    background: var(--c-3);
    color: var(--c-f);
    border: 0 solid #fff;
		border-radius: 0.3rem;
    margin: 0px 6px;
    font-size: 19px;
    transition: background-color .2s;
    outline: 0;
    width: 100px;
    -webkit-appearance: textfield;
    -moz-appearance: textfield;
    appearance: textfield
  }
  
  ::selection {
    background: var(--c-b)
  }

  input[type=number] {
    text-align: right;
  }

  input[type=text] {
    width: 200px;
    text-align: center
    -webkit-appearance: textfield;
    -moz-appearance: textfield;
    appearance: textfield
  }

  input[type=number]:focus,
  input[type=text]:focus {
    background: var(--c-6)
  }

/*
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none
  }
*/

  .rmbutton {
    color: var(--c-f);
		border-radius: 0.3rem;
    background-color: red;
  }
  
  .btn {
		border: 0;
		border-radius: 0.3rem;
		background: #1fa3ec;
		color: #faffff;
		line-height: 2.4rem;
		font-size: 1.2rem;
    padding: 8px;
    margin: 10px;
    width: 230px;
		-webkit-transition-duration: 0.4s;
		transition-duration: 0.4s;
		cursor: pointer;
	}

</style>
</head>

<body>
  <h3>Drag and drop from Animations to Playlist, rearrange, adjust play time, and save to make a playlist.</h3>
  <div class="plm">
    <div>
      <h4>Saved Animations</h4>
      <ul id="ul_source">
      </ul>
    </div>
    <div class="dropzone">
      <h4>New Playlist</h4>
      <ul id="ul_playlist">
      </ul>
    </div>
  </div>

  <label>Playlist ID: <input id="plid" type="text" value="" placeholder="name your playlist"></input><label>
  <button id="mysbutton" class="btn btn-s btn-i">Save</button>


<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.10.1/Sortable.min.js"></script>
<script>

let base_url = "";
if (window.location.protocol == "file:") {
	// makes for easier debugging.
	// if html is loaded locally, can see the results of editing more easily.
	// otherwise every change to html would require uploading new version to microcontroller.
	base_url = "http://192.168.1.243";
}

let ul_source = document.getElementById("ul_source");
let ul_playlist = document.getElementById("ul_playlist");

new Sortable(ul_source, {
  group: {
    name: "plm_lists",
    pull: "clone",
    put: false
  },
  animation: 150,
  sort: false
});

let playlist = new Sortable(ul_playlist, {
  group: {
    name: "plm_lists",
    pull: "clone"
  },
  animation: 150,
  filter: ".rmbutton",
  onAdd: function (evt) {
    let item = evt.item;
    item.insertAdjacentHTML("beforeend", '<input title="seconds" type="number" step="0.1" value="20"/>')
    item.insertAdjacentHTML("beforeend", '<input type="button" value="x" class="rmbutton"/>')
  },
  onFilter: function (evt) {
    let item = evt.item;
    let ctrl = evt.target;
    
    if (Sortable.utils.is(ctrl, ".rmbutton")) {
      item.parentNode.removeChild(item);
    }
  },
  // prevents input field from being an area that be grabbed so cursor works normally
  filter: 'input',
  preventOnFilter: false
});


function populate_effects(list) {
  for (let i = 0; i < list.length; i++) {
    let type = list[i]["type"]; 
    let id = list[i]["path"];
    let name = list[i]["name"];
    if(type && id && name && type === "file" && (id.startsWith("/files/im/") || id.startsWith("/files/cm/"))) { 
      ul_source.insertAdjacentHTML("beforeend", `<li data-amid="${id}">${name}</li>`)
    }
    ul_playlist.style.minHeight = ul_source.offsetHeight;
  }
}


async function fetch_source() {
  const t = await fetch(base_url+"/file_list.json");
  let reply = await t.json();
  populate_effects(reply);
}


async function save() {
  const type = "pl";
  let plid = document.getElementById("plid").value;
  let li = ul_playlist.getElementsByTagName("li");
  
  console.log(plid);
    
  if (plid && li.length > 0) {
    let o = {};
    o.t = type;
    o.id = plid.toString();
    o.am = [];
    for (let i = 0; i < li.length; i++) {
      o.am.push({"id": li[i].getAttribute("data-amid"), "d": "!!"+(1000*li[i].children[0].value)+"!!"})
    }
    let json = JSON.stringify(o);
    //stringify() wraps numbers in quotes so wrap numbers in !! to make it easy to remove the quotes
    const regex = /"!!(-?[0-9]+\.{0,1}[0-9]*)!!"/g 
    json = json.replace(regex, '$1')
    console.log(json);
    
    console.log(`t=${type}&id=${plid}&json=` + json);

    const t = await fetch("http://192.168.1.243/save", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `t=${type}&id=${plid}&json=` + json
    }),
    reply = await t.json();
    console.log(reply)

  }
  else {
    console.log("Missing Playlist ID or playlist is empty.");
  }
}


let sbutton = document.getElementById("mysbutton");
sbutton.onclick = function(){save()};

window.addEventListener("load", fetch_source);

</script>
</body>
</html>
