<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
  <meta charset="utf-8">
  <meta name="theme-color" content="#222222">
  <meta content="yes" name="apple-mobile-web-app-capable">
  
<title>Playlist Maker</title>
<style>
  html {
    touch-action: manipulation
    overflow: auto;
  }

  body {
    font-family: Arial, sans-serif;
    color: #faffff;
    background: #111;
    font-size: 17px;
    text-align: center;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
  
  #return_main_menu {
    float: left;
  }

  .grid-container {
    display: grid;
    grid-template-columns: repeat(3, minmax(20px, 1fr));
    grid-column-gap: 5px;
    width: 1000px;
    max-width: 100vw;
    justify-content: center;
    margin: 5px auto;
    padding: 5px;
  }

  .grid-container div {
    border: 1px solid #fff;
  }
  
  ul {
    margin: 0;
    padding: 0;
  }

   #savebtn,
   li {
    border: 0;
    border-radius: 0.3rem;
    line-height: 1.6rem;
    font-size: 0.8rem;
    -webkit-transition-duration: 0.4s;
    transition-duration: 0.4s;
    cursor: pointer;
    margin: 5px auto;
  }
  
  li {
    list-style: none;
    padding: 8px 0px;
    width: 100%;
    overflow-wrap: anywhere;
  }

  #savebtn {
    background: #1fa3ec;
  }

  #ul_playlist {
    background-color: #333;
  }

  #ul_playlist > li {
    display: grid;
    grid-template-columns: auto auto;
    cursor: move;
  }

  #ul_playlist > li.selected {
    background: rgba(255,0,0,.5);
  }
  
  #ul_playlist > li > label{
    grid-column: span 2;
    overflow-wrap: anywhere;
  }

  .image {
    background: #bb8888;
  }
  
  .composite {
    background: #88bb88;
  }

  .playlist {
    background: #8888bb;
  }

  input[type=number],
  input[type=text] {
    color: #faffff;
    background: #333;
    border: 0 solid #fff;
    border-radius: 0.3rem;
    margin: 0px 6px;
    font-size: 19px;
    transition: background-color .2s;
    outline: 0;
    -webkit-appearance: textfield;
    -moz-appearance: textfield;
    appearance: textfield
  }
  
  ::selection {
    background: #bbb;
  }

  input[type=number] {
    text-align: right;
    max-width: 35px;
    max-height: 20px;
    margin-left: auto;
  }

  input[type=text] {
    text-align: center;
    max-width: 200px;
  }

  input[type=number]:focus,
  input[type=text]:focus {
    background: #666
  }

  .rmbutton {
    color: #faffff;
    background-color: #f00;
    border-radius: 0.3rem;
    max-width: 20px;
    max-height: 20px;
  }

</style>
</head>

<body>
  <a id="return_main_menu" href="./index.html"><svg height="24px" width="24px" viewBox="0 0 16 16" id="Layer_1" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path fill="white" d="M15.45,7L14,5.551V2c0-0.55-0.45-1-1-1h-1c-0.55,0-1,0.45-1,1v0.553L9,0.555C8.727,0.297,8.477,0,8,0S7.273,0.297,7,0.555  L0.55,7C0.238,7.325,0,7.562,0,8c0,0.563,0.432,1,1,1h1v6c0,0.55,0.45,1,1,1h3v-5c0-0.55,0.45-1,1-1h2c0.55,0,1,0.45,1,1v5h3  c0.55,0,1-0.45,1-1V9h1c0.568,0,1-0.437,1-1C16,7.562,15.762,7.325,15.45,7z"/></svg></a>

  <h3>Click an item in Saved Art or Saved Playlists to load it into the Edit Playlist area. Drag and drop to rearrange items, adjust play time, and save to make a playlist.</h3>

  <label>Playlist ID: <input id="plid" type="text" value="" placeholder="name your playlist" autocomplete="off"></input></label>
  <button id="savebtn">Save</button>
  <div class="grid-container">
    <div>
      <h4>Saved Art</h4>
      <ul id="art_btns">
      </ul>
    </div>
    <div class="dropzone">
      <h4>Edit Playlist</h4>
      <ul id="ul_playlist">
      </ul>
    </div>
    <div>
      <h4>Saved Playlists</h4>
      <ul id="pl_btns">
      </ul>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.10.1/Sortable.min.js"></script>
<script>

let base_url = "";
if (window.location.protocol == "file:") {
  // makes for easier debugging.
  // if html is loaded locally, can see the results of editing more easily.
  // otherwise every change to html would require uploading new version to microcontroller.
  base_url = "http://192.168.1.243";
}


let ul_playlist = document.getElementById("ul_playlist");


function add(item, value) {
    item.insertAdjacentHTML("beforeend", `<input title="seconds" type="number" min="0.001" step="0.1" value="${value}"/>`)
    item.insertAdjacentHTML("beforeend", '<input type="button" value="x" class="rmbutton"/>')
}

let playlist = new Sortable(ul_playlist, {
  group: {
    name: "plm_lists",
    //pull: "clone"
  },
  animation: 150,
  filter: ".rmbutton",
  //onAdd: function (evt) {add(evt.item, 20)},
  onFilter: function (evt) {
    let item = evt.item;
    let ctrl = evt.target;
    
    if (Sortable.utils.is(ctrl, ".rmbutton")) {
      item.parentNode.removeChild(item);
    }
  },
  // prevents input field from being an area that can be grabbed so cursor works normally
  filter: 'input',
  preventOnFilter: false
});


async function load_effect_into_dropzone(id, stem) {
  if (id.startsWith("/files/im/")) {
    ul_playlist.insertAdjacentHTML("beforeend", `<li class="image" data-amid="${id}"><label>${stem}</label></li>`);
    add(ul_playlist.lastElementChild, 20);
  }
  else if (id.startsWith("/files/cm/")) {
    ul_playlist.insertAdjacentHTML("beforeend", `<li class="composite" data-amid="${id}"><label>${stem}</label></li>`);
    add(ul_playlist.lastElementChild, 20);
  }
}


async function load_playlist_into_dropzone(id) {
  const t = await fetch(base_url+id);
  let list = await t.json();
  if (list) {
    let items = list["am"];
    console.log(list);
    for (let i = 0; i < items.length; i++) {
      let id = items[i]["id"];
      let name = id.substring(id.lastIndexOf('/') + 1);
      let stem = name.replace(/\.[^/.]+$/, "");
      let d = items[i]["d"];
      if (id.startsWith("/files/im/")) { 
        ul_playlist.insertAdjacentHTML("beforeend", `<li class="image" data-amid="${id}"><label>${stem}</label></li>`);
        // not sure why this doesn't work
        //let event = new Event('add', { bubbles: true });
        //ul_playlist.lastElementChild.dispatchEvent(event);
        add(ul_playlist.lastElementChild, d/1000);
      }
      else if (id.startsWith("/files/cm/")) { 
        ul_playlist.insertAdjacentHTML("beforeend", `<li class="composite" data-amid="${id}"><label>${stem}</label></li>`);
        add(ul_playlist.lastElementChild, d/1000);
      }
    }
    document.getElementById("plid").value = list["id"];
  }
}


function populate_effects(list) {
  let art_btns_div = document.getElementById("art_btns");
  let pl_btns_div = document.getElementById("pl_btns");
  for (let i = 0; i < list.length; i++) {
    let type = list[i]["type"]; 
    let id = list[i]["path"];
    let name = list[i]["name"];
    let stem = name.replace(/\.[^/.]+$/, "");
    if (type && id && stem && type === "file") { 
      if (id.startsWith("/files/im/")) {
        art_btns_div.insertAdjacentHTML("beforeend", `<li class="image" onclick="load_effect_into_dropzone('${id}', '${stem}')">${stem}</li>`)
      }
      else if (id.startsWith("/files/cm/")) {
        art_btns_div.insertAdjacentHTML("beforeend", `<li class="composite" onclick="load_effect_into_dropzone('${id}', '${stem}')">${stem}</li>`)
      }
      else if (id.startsWith("/files/pl/")) {
        pl_btns_div.insertAdjacentHTML("beforeend", `<li class="playlist" onclick="load_playlist_into_dropzone('${id}')">${stem}</li>`)
      }
    }
    ul_playlist.style.minHeight = art_btns.offsetHeight;
  }
}


async function fetch_source() {
  const t = await fetch(base_url+"/file_list.json");
  let reply = await t.json();
  populate_effects(reply);
}


async function save() {
  const type = "pl";
  let plid = document.getElementById("plid").value;
  let li = ul_playlist.getElementsByTagName("li");
  
  console.log(plid);
    
  if (plid && li.length > 0) {
    let o = {};
    o.t = type;
    o.id = plid.toString();
    o.am = [];
    for (let i = 0; i < li.length; i++) {
      let v = li[i].children[1].value;
      if (isNaN(v) || v < 0.001) {
        v = 0.001;
      }
      o.am.push({"id": li[i].getAttribute("data-amid"), "d": "!!"+(1000*v)+"!!"})
    }
    let json = JSON.stringify(o);
    //stringify() wraps numbers in quotes so wrap numbers in !! to make it easy to remove the quotes
    const regex = /"!!(-?[0-9]+\.{0,1}[0-9]*)!!"/g 
    json = json.replace(regex, '$1')
    console.log(json);
    
    console.log(`t=${type}&id=${plid}&json=` + json);

    const t = await fetch("http://192.168.1.243/save", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `t=${type}&id=${plid}&json=` + json
    }),
    reply = await t.json();
    console.log(reply)
  }
  else {
    console.log("Missing Playlist ID or playlist is empty.");
  }
}


let sbutton = document.getElementById("savebtn");
sbutton.onclick = function(){save()};

window.addEventListener("load", fetch_source);

</script>
</body>
</html>
